<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排行榜管理</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f8f9fa; /* 更清爽的背景色 */
            color: #495057; /* 柔和的文字颜色 */
        }
        .container {
            background-color: #ffffff; /* 白色容器背景 */
            border-radius: 8px;
            padding: 25px 35px; /* 调整内边距 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* 柔和的阴影 */
        }
        button {
            background-color: #007bff; /* 蓝色主色调 */
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 5px; /* 稍圆润的边角 */
            cursor: pointer;
            font-size: 15px;
            font-weight: 500; /* 稍加粗 */
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: #0056b3; /* 悬停时加深颜色 */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid transparent; /* 添加边框基准 */
        }
        .success {
            background-color: #e6f7ff; /* 淡蓝色成功提示 */
            color: #1890ff;
            border-color: #91d5ff;
        }
        .error {
            background-color: #fff1f0; /* 淡红色错误提示 */
            color: #f5222d;
            border-color: #ffa39e;
        }
        #loginScreen {
            text-align: center;
            max-width: 500px;
            margin: 40px auto; /* 增加上下边距 */
            padding: 40px 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #loginScreen h2 {
            margin-bottom: 30px;
            color: #343a40; /* 深灰色标题 */
        }
        /* 表单控件样式 */
        input, select {
            padding: 10px 12px;
            margin: 10px 0;
            width: 100%;
            max-width: 320px;
            border: 1px solid #ced4da; /* 柔和的边框色 */
            border-radius: 5px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        input:focus, select:focus {
            border-color: #80bdff; /* 蓝色焦点边框 */
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); /* 蓝色焦点阴影 */
        }
        #adminPanel {
            display: none;
        }
        
        /* 排行榜表格样式 */
        .leaderboards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 30px;
        }
        .leaderboard-section {
            flex: 1;
            min-width: 48%;
            background-color: #fff; /* 白色背景 */
            padding: 20px; /* 添加内边距 */
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06); /* 轻微阴影 */
        }
        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px; /* 增加底部内边距 */
            border-bottom: 1px solid #e9ecef; /* 分隔线 */
        }
        .leaderboard-header h3 {
            margin: 0;
            font-size: 1.2rem; /* 调整字体大小 */
            color: #495057;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px; /* 增加与头部间距 */
            background-color: white;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6; /* 更清晰的分割线 */
            white-space: nowrap; /* 防止文字折行 */
            vertical-align: middle; /* 垂直居中 */
        }
        th {
            background-color: #f8f9fa; /* 浅灰表头 */
            position: sticky;
            top: 0;
            font-weight: 600;
            color: #495057; /* 表头文字颜色 */
        }
        tr:hover {
            background-color: #f1f3f5; /* 柔和的悬停效果 */
        }
        .leaderboard-table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6; /* 统一边框颜色 */
            border-radius: 5px;
        }
        
        /* 操作列按钮样式 */
        .actions-cell {
            text-align: right; /* 按钮靠右 */
        }
        .actions-container {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* 按钮从左开始排列 */
            gap: 8px; /* 按钮间距 */
        }
        
        .delete-btn, .block-ip-btn {
            padding: 6px 12px; /* 调整按钮大小 */
            font-size: 14px;
            white-space: nowrap; /* 防止按钮内文字折行 */
        }
        
        .delete-btn {
            background-color: #dc3545; /* 红色删除按钮 */
            color: white;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .block-ip-btn {
            background-color: #ffc107; /* 黄色屏蔽按钮 */
            color: #212529; /* 深色文字 */
        }
        .block-ip-btn:hover {
            background-color: #e0a800;
        }
        
        .section {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 1px solid #e9ecef;
        }
        #refreshBtn, #refreshAllBtn, #refreshBlockedIpsBtn {
            background-color: #17a2b8; /* 青色刷新按钮 */
            margin-right: 10px;
        }
        #refreshBtn:hover, #refreshAllBtn:hover, #refreshBlockedIpsBtn:hover {
            background-color: #138496;
        }
        
        /* 日期选择器样式 */
        .date-selector {
            display: flex;
            align-items: center;
            margin-top: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .date-selector label {
            margin-right: 10px;
            font-weight: 500; /* 调整字重 */
            min-width: 80px; /* 调整宽度 */
            color: #6c757d; /* 标签颜色 */
        }
        .date-selector input {
            max-width: 180px; /* 调整输入框宽度 */
            margin: 0;
        }
        .date-selector button {
            background-color: #28a745; /* 绿色应用按钮 */
            padding: 10px 15px;
            margin-left: 10px;
            white-space: nowrap;
        }
         .date-selector button:hover {
             background-color: #218838;
         }
        
        /* 排序选项 */
        .sort-options {
            display: flex;
            align-items: center;
            margin-left: auto;
        }
        .sort-options label {
            margin-right: 10px;
            color: #6c757d; /* 标签颜色 */
        }
        .sort-options select {
            padding: 6px 8px; /* 调整内边距 */
            border-radius: 5px;
            border: 1px solid #ced4da;
            background-color: #fff; /* 白色背景 */
        }
        
        /* 加载指示器 */
        .loading {
            padding: 30px; /* 增加内边距 */
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        /* 空数据提示 */
        .empty-data {
            padding: 30px; /* 增加内边距 */
            color: #6c757d;
            font-style: italic;
            text-align: center; /* 居中 */
        }
        
        /* 标签页样式 */
        .tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6; /* 更清晰的分割线 */
            margin-bottom: 25px; /* 增加间距 */
        }
        .tab {
            padding: 12px 22px; /* 调整内边距 */
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 6px 6px 0 0; /* 调整圆角 */
            background-color: #e9ecef; /* 非激活标签背景 */
            margin-right: 5px;
            color: #495057; /* 标签文字颜色 */
            transition: background-color 0.2s, border-color 0.2s;
        }
        .tab:hover {
            background-color: #f8f9fa; /* 悬停时变亮 */
        }
        .tab.active {
            background-color: #fff; /* 激活标签背景 */
            border-color: #dee2e6;
            border-bottom-color: #fff;
            font-weight: 600; /* 激活时加粗 */
            color: #007bff; /* 激活时蓝色文字 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* IP屏蔽管理样式 */
        .ip-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center; /* 垂直居中 */
        }
        .ip-input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        #ipToBlock {
            width: 250px; /* 调整宽度 */
            margin: 0;
        }
        .blocked-ips-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* 轻微阴影 */
        }
        .unblock-btn {
            background-color: #6c757d; /* 灰色解除屏蔽按钮 */
        }
        .unblock-btn:hover {
            background-color: #5a6268;
        }
        /* 为IP列中添加特殊样式 */
        .ip-column {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace; /* 更适合代码的字体 */
            font-size: 14px;
            color: #e83e8c; /* 粉色IP地址 */
            font-weight: 500;
        }
        /* 为表格中的操作按钮添加统一样式 */
        .table-action-btn {
            padding: 6px 12px; /* 调整按钮大小 */
            font-size: 14px;
        }
        /* 屏蔽原因样式 */
        .block-reason {
            font-size: 13px;
            color: #6c757d; /* 灰色文字 */
            margin-top: 4px;
            line-height: 1.4;
            display: block;
            white-space: normal; /* 允许原因换行 */
        }
        .block-timestamp {
            font-size: 12px;
            color: #adb5bd; /* 更浅的灰色时间戳 */
            margin-top: 2px;
            display: inline-block;
        }
        .block-type {
            display: inline-block;
            padding: 3px 8px; /* 调整内边距 */
            border-radius: 4px; /* 调整圆角 */
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
            text-transform: uppercase; /* 大写 */
        }
        .block-type-manual {
            background-color: #dc3545; /* 红色 */
            color: white;
        }
        .block-type-auto {
            background-color: #ffc107; /* 黄色 */
            color: #212529;
        }
        .ip-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .player-info {
            font-size: 13px;
            color: #495057;
            margin-top: 3px;
        }
        h1 {
            font-size: 2rem; /* 调整标题大小 */
            margin-bottom: 30px;
            color: #343a40;
            border-bottom: 2px solid #e9ecef; /* 分隔线 */
            padding-bottom: 15px;
            font-weight: 600; /* 加粗 */
        }
        h2 {
            font-size: 1.6rem; /* 调整副标题大小 */
            margin-top: 0;
            margin-bottom: 25px;
            color: #343a40;
            font-weight: 600;
        }
        h3 {
            font-size: 1.3rem; /* 调整小标题大小 */
            margin-top: 25px;
            margin-bottom: 15px;
            color: #495057;
            font-weight: 500;
        }
        /* 添加响应式布局优化 */
        @media (max-width: 1200px) {
            .leaderboards-container {
                flex-direction: column;
                gap: 20px; /* 调整间距 */
            }
            .leaderboard-section {
                min-width: 100%;
            }
        }
        @media (max-width: 768px) {
             h1 { font-size: 1.8rem; }
             h2 { font-size: 1.4rem; }
             h3 { font-size: 1.1rem; }
             .container { padding: 20px; }
             .leaderboard-header { flex-direction: column; align-items: flex-start; gap: 10px; }
             .sort-options { margin-left: 0; }
             th, td { padding: 10px; font-size: 14px;}
             .actions-container { flex-direction: column; align-items: flex-start; gap: 5px;}
             .delete-btn, .block-ip-btn { width: 100%; text-align: center; } /* 按钮占满宽度 */
             .ip-actions { flex-direction: column; align-items: stretch; }
             #ipToBlock { width: 100%; }
        }
        
        /* 面板操作区域 */
        .panel-actions {
            display: flex;
            justify-content: flex-start; /* 从左开始 */
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px; /* 调整间距 */
            align-items: center;
        }
        
        /* 主要操作按钮 */
        .primary-action {
            background-color: #007bff; /* 统一主色调 */
            font-weight: 500;
            padding: 12px 20px;
            display: inline-flex; /* 改为 inline-flex */
            align-items: center;
            gap: 8px;
        }
        
        .primary-action:hover {
            background-color: #0056b3;
        }
        
        /* 图标样式 */
        .icon-refresh:before {
            content: "\21BB"; /* Unicode 刷新符号 */
            font-weight: bold;
            font-size: 1.1em; /* 稍微放大图标 */
            line-height: 1; /* 确保垂直对齐 */
        }
        
        /* 标签页内容区域 */
        .tab-content {
            background-color: #fff;
            border: 1px solid #dee2e6; /* 添加边框 */
            border-top: none; /* 移除顶部边框 */
            border-radius: 0 0 6px 6px; /* 调整圆角 */
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: -1px; /* 与标签底部边框重叠 */
        }
        
        /* 描述文本 */
        .description {
            color: #6c757d; /* 灰色描述文字 */
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        /* 按钮样式扩展 */
        .block-action {
            background-color: #ffc107; /* 黄色屏蔽按钮 */
            color: #212529;
            font-weight: 500;
        }
        .block-action:hover {
            background-color: #e0a800;
        }
        
        .secondary-action {
            background-color: #17a2b8; /* 青色次要按钮 */
            display: inline-flex; /* 改为 inline-flex */
            align-items: center;
            gap: 8px;
        }
        .secondary-action:hover {
            background-color: #138496;
        }

        /* 分页样式 */
        .pagination {
            margin-top: 20px;
            text-align: center;
        }
        .pagination button {
            margin: 0 5px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            color: #007bff;
            border: 1px solid #dee2e6;
            font-weight: 500;
        }
        .pagination button:hover:not(:disabled) {
            background-color: #e2e6ea;
        }
        .pagination button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        #pageInfo {
            margin: 0 10px;
            font-weight: 500;
            color: #495057;
        }

        /* 高级管理筛选器 */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-group label {
            font-weight: 500;
            color: #6c757d;
            min-width: 80px;
        }
        .filter-group select, .filter-group input {
            margin: 0;
            max-width: 180px;
        }
        #applyFilters {
             background-color: #28a745; /* 绿色应用按钮 */
             margin-left: auto; /* 推动到右侧 */
        }
         #applyFilters:hover {
             background-color: #218838;
         }

    </style>
</head>
<body>
    <div class="container">
        <h1>排行榜管理</h1>
        
        <div id="loginScreen">
            <h2>管理员登录</h2>
            <input type="password" id="adminPassword" placeholder="请输入管理员密码">
            <button id="loginButton">登录</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>
        
        <div id="adminPanel">
            <div class="tabs">
                <div class="tab active" data-tab="leaderboards">游戏排行榜</div>
                <div class="tab" data-tab="management">高级管理</div>
                <div class="tab" data-tab="blockedIps">IP屏蔽管理</div>
            </div>
            
            <!-- 排行榜标签页 -->
            <div id="leaderboardsTab" class="tab-content active">
                <div class="panel-actions">
                    <button id="refreshAllBtn" class="primary-action"><i class="icon-refresh"></i> 刷新所有数据</button>
                </div>
                
                <div class="leaderboards-container">
                    <!-- 无尽模式排行榜 -->
                    <div class="leaderboard-section">
                        <div class="leaderboard-header">
                            <h3>无尽模式排行榜</h3>
                            <div class="sort-options">
                                <label for="endlessSortOption">排序:</label>
                                <select id="endlessSortOption" class="sort-option" data-mode="endless">
                                    <option value="score">按分数</option>
                                    <option value="time">按时间</option>
                                </select>
                            </div>
                        </div>
                        <div class="leaderboard-table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th width="5%">排名</th>
                                        <th width="20%">玩家名称</th>
                                        <th width="10%">分数</th>
                                        <th width="15%">日期</th>
                                        <th width="18%">IP地址</th>
                                        <th width="32%">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="endlessLeaderboardData">
                                    <tr>
                                        <td colspan="6" class="loading">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 每日挑战排行榜 -->
                    <div class="leaderboard-section">
                        <div class="leaderboard-header">
                            <h3>每日挑战排行榜</h3>
                            <div class="sort-options">
                                <label for="challengeSortOption">排序:</label>
                                <select id="challengeSortOption" class="sort-option" data-mode="challenge">
                                    <option value="score">按分数</option>
                                    <option value="time">按时间</option>
                                </select>
                            </div>
                        </div>
                        <div class="date-selector">
                            <label for="challengeDateFilter">选择日期:</label>
                            <input type="date" id="challengeDateFilter" value="">
                            <button id="applyDateFilter">应用</button>
                        </div>
                        <div class="leaderboard-table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th width="5%">排名</th>
                                        <th width="20%">玩家名称</th>
                                        <th width="10%">分数</th>
                                        <th width="15%">日期</th>
                                        <th width="18%">IP地址</th>
                                        <th width="32%">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="challengeLeaderboardData">
                                    <tr>
                                        <td colspan="6" class="loading">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 高级管理标签页 -->
            <div id="managementTab" class="tab-content">
                <div class="section">
                    <h2>高级排行榜管理</h2>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label for="modeFilter">游戏模式:</label>
                            <select id="modeFilter">
                                <option value="">全部</option>
                                <option value="endless">无尽模式</option>
                                <option value="challenge">每日挑战</option>
                            </select>
                        </div>
                        
                        <div class="filter-group" id="dateFilterContainer">
                            <label for="dateFilter">挑战日期:</label>
                            <input type="date" id="dateFilter">
                        </div>
                        
                        <div class="filter-group">
                            <label for="sortFilter">排序方式:</label>
                            <select id="sortFilter">
                                <option value="score">按分数排序</option>
                                <option value="time">按时间排序</option>
                            </select>
                        </div>
                        
                        <button id="applyFilters">应用筛选</button>
                    </div>
                    
                    <div id="advancedLeaderboardContainer">
                        <table id="advancedLeaderboardTable">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>玩家名称</th>
                                    <th>分数</th>
                                    <th>日期</th>
                                    <th>模式</th>
                                    <th>IP地址</th>
                                    <th width="30%">操作</th>
                                </tr>
                            </thead>
                            <tbody id="advancedLeaderboardData">
                                <!-- 数据将在这里动态加载 -->
                            </tbody>
                        </table>
                        <div class="pagination" id="pagination">
                            <button id="firstPage">首页</button>
                            <button id="prevPage">上一页</button>
                            <span id="pageInfo">第 0/0 页</span>
                            <button id="nextPage">下一页</button>
                            <button id="lastPage">末页</button>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                <h2>清空排行榜</h2>
                <p>警告：此操作将删除所有排行榜数据，且不可恢复！</p>
                <button id="clearButton">清空排行榜</button>
            </div>
            </div>
            
            <!-- IP屏蔽管理标签页 -->
            <div id="blockedIpsTab" class="tab-content">
                <h2>IP屏蔽管理</h2>
                <div class="section">
                    <div class="ip-actions">
                        <div class="ip-input-group">
                            <input type="text" id="ipToBlock" placeholder="输入要屏蔽的IP地址">
                            <button id="blockIpBtn" class="block-action">屏蔽IP</button>
                        </div>
                        <button id="refreshBlockedIpsBtn" class="secondary-action"><i class="icon-refresh"></i> 刷新IP列表</button>
                    </div>
                    
                    <h3>已屏蔽的IP列表</h3>
                    <p class="description">以下IP地址已被屏蔽，这些IP地址的用户将无法提交分数（但用户不会收到任何提示）。</p>
                    <div class="blocked-ips-container">
                        <table id="blockedIpsTable">
                            <thead>
                                <tr>
                                    <th width="20%">IP地址</th>
                                    <th width="50%">屏蔽详情</th>
                                    <th width="30%">操作</th>
                                </tr>
                            </thead>
                            <tbody id="blockedIpsData">
                                <tr>
                                    <td colspan="3" class="loading">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // 设置今天的日期为默认值
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('challengeDateFilter').value = today;
        });
        
        // 标签页切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // 移除所有标签页的active类
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // 添加当前标签页的active类
                this.classList.add('active');
                document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
                
                // 如果切换到IP屏蔽管理标签，刷新IP列表
                if (this.dataset.tab === 'blockedIps') {
                    loadBlockedIps();
                }
            });
        });
        
        // 当前页码和分页状态
        let currentPage = 1;
        let paginationState = {
            totalPages: 0,
            currentPage: 1,
            pageSize: 10
        };
        
        // 筛选设置
        let filterSettings = {
            mode: '',
            date: '',
            sortBy: 'score'
        };
        
        // 初始化日期筛选器
        document.getElementById('modeFilter').addEventListener('change', function() {
            const dateFilterContainer = document.getElementById('dateFilterContainer');
            if (this.value === 'challenge') {
                dateFilterContainer.style.display = 'flex';
            } else {
                dateFilterContainer.style.display = 'none';
                document.getElementById('dateFilter').value = '';
            }
        });
        
        // 应用筛选按钮
        document.getElementById('applyFilters').addEventListener('click', function() {
            filterSettings.mode = document.getElementById('modeFilter').value;
            filterSettings.sortBy = document.getElementById('sortFilter').value;
            
            if (filterSettings.mode === 'challenge') {
                filterSettings.date = document.getElementById('dateFilter').value;
            } else {
                filterSettings.date = '';
            }
            
            // 重新加载数据，并回到第一页
            loadAdvancedLeaderboardData(1);
        });
        
        // 日期筛选应用按钮
        document.getElementById('applyDateFilter').addEventListener('click', function() {
            const date = document.getElementById('challengeDateFilter').value;
            loadChallengeLeaderboard(date);
        });
        
        // 排序选项更改事件
        document.querySelectorAll('.sort-option').forEach(select => {
            select.addEventListener('change', function() {
                const mode = this.getAttribute('data-mode');
                const sortBy = this.value;
                
                if (mode === 'endless') {
                    loadEndlessLeaderboard(sortBy);
                } else if (mode === 'challenge') {
                    const date = document.getElementById('challengeDateFilter').value;
                    loadChallengeLeaderboard(date, sortBy);
                }
            });
        });
        
        // 刷新所有按钮
        document.getElementById('refreshAllBtn').addEventListener('click', function() {
            loadAllLeaderboards();
        });
        
        // 简单的密码验证
        document.getElementById('loginButton').addEventListener('click', async function() {
            const password = document.getElementById('adminPassword').value;
            
            try {
                // 通过API验证密码
                const response = await fetch('/api/verify-admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // 密码正确，显示管理面板
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    
                    // 加载所有排行榜数据
                    loadAllLeaderboards();
                } else {
                    // 密码错误，显示错误消息
                    const loginResult = document.getElementById('loginResult');
                    loginResult.style.display = 'block';
                    loginResult.className = 'result error';
                    loginResult.innerHTML = '<p>密码错误，请重试</p>';
                    
                    // 3秒后隐藏错误消息
                    setTimeout(() => {
                        loginResult.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                const loginResult = document.getElementById('loginResult');
                loginResult.style.display = 'block';
                loginResult.className = 'result error';
                loginResult.innerHTML = '<p>验证失败，请重试</p>';
            }
        });
        
        // 加载所有排行榜
        function loadAllLeaderboards() {
            // 加载无尽模式排行榜
            loadEndlessLeaderboard();
            
            // 加载今日挑战排行榜
            const today = document.getElementById('challengeDateFilter').value;
            loadChallengeLeaderboard(today);
            
            // 加载高级管理数据
            loadAdvancedLeaderboardData(1);
            
            // 加载屏蔽IP列表
            loadBlockedIps();
            
            // 确保所有按钮的事件监听器都已添加或更新
            setTimeout(addBlockIpListeners, 200); // 延迟确保DOM更新完毕
        }
        
        // 加载无尽模式排行榜
        async function loadEndlessLeaderboard(sortBy = 'score') {
            try {
                const password = document.getElementById('adminPassword').value;
                
                // 显示加载中
                document.getElementById('endlessLeaderboardData').innerHTML = '<tr><td colspan="6" class="loading">加载中...</td></tr>';
                
                const response = await fetch(`/api/get-leaderboard?mode=endless&sortBy=${sortBy}&page=1&pageSize=20`, {
                    headers: {
                        'Admin-Password': password
                    }
                });
                const result = await response.json();
                
                if (response.ok) {
                    const tableBody = document.getElementById('endlessLeaderboardData');
                    // 移除所有子元素和绑定的事件监听器
                    while (tableBody.firstChild) {
                        tableBody.removeChild(tableBody.firstChild);
                    }
                    
                    const data = result.data || [];
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="empty-data">暂无排行榜数据</td></tr>';
                        return;
                    }
                    
                    // 将数据添加到表格中
                    data.forEach((item, index) => {
                        const row = document.createElement('tr');
                        const date = new Date(item.date);
                        const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.playerName}</td>
                            <td>${item.score}</td>
                            <td>${formattedDate}</td>
                            <td class="ip-column">${item.ip || '未知'}</td>
                            <td class="actions-cell">
                                <div class="actions-container">
                                    <button class="delete-btn table-action-btn" data-id="${item.id}">删除</button>
                                    ${item.ip ? `<button class="block-ip-btn table-action-btn" data-ip="${item.ip}">屏蔽IP</button>` : ''}
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // 为无尽模式表格添加屏蔽按钮事件 (已在上方添加)
                    // setTimeout(addBlockButtonToTable, 100); // 不再需要单独添加
                    
                    // 添加删除按钮的事件监听
                    tableBody.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            if (confirm('确定要删除这条记录吗？')) {
                                deleteRecord(this.getAttribute('data-id'));
                            }
                        });
                    });
                } else {
                    document.getElementById('endlessLeaderboardData').innerHTML = 
                        `<tr><td colspan="6" class="error">获取数据失败: ${result.error || '未知错误'}</td></tr>`;
                }
            } catch (error) {
                document.getElementById('endlessLeaderboardData').innerHTML = 
                    `<tr><td colspan="6" class="error">加载数据时出错: ${error.message || '连接服务器失败'}</td></tr>`;
            }
        }
        
        // 加载每日挑战排行榜
        async function loadChallengeLeaderboard(date, sortBy = 'score') {
            try {
                const password = document.getElementById('adminPassword').value;
                
                // 显示加载中
                document.getElementById('challengeLeaderboardData').innerHTML = '<tr><td colspan="6" class="loading">加载中...</td></tr>';
                
                const params = new URLSearchParams({
                    mode: 'challenge',
                    sortBy: sortBy,
                    page: 1,
                    pageSize: 20
                });
                
                if (date) {
                    params.append('date', date);
                }
                
                const response = await fetch(`/api/get-leaderboard?${params.toString()}`, {
                    headers: {
                        'Admin-Password': password
                    }
                });
                const result = await response.json();
                
                if (response.ok) {
                    const tableBody = document.getElementById('challengeLeaderboardData');
                    // 移除所有子元素和绑定的事件监听器
                    while (tableBody.firstChild) {
                        tableBody.removeChild(tableBody.firstChild);
                    }
                    
                    const data = result.data || [];
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="empty-data">暂无排行榜数据</td></tr>';
                        return;
                    }
                    
                    // 将数据添加到表格中
                    data.forEach((item, index) => {
                        const row = document.createElement('tr');
                        const date = new Date(item.date);
                        const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.playerName}</td>
                            <td>${item.score}</td>
                            <td>${formattedDate}</td>
                            <td class="ip-column">${item.ip || '未知'}</td>
                            <td class="actions-cell">
                                <div class="actions-container">
                                    <button class="delete-btn table-action-btn" data-id="${item.id}">删除</button>
                                    ${item.ip ? `<button class="block-ip-btn table-action-btn" data-ip="${item.ip}">屏蔽IP</button>` : ''}
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // 为每日挑战表格添加屏蔽按钮事件 (已在上方添加)
                    // setTimeout(addBlockButtonToTable, 100); // 不再需要单独添加
                    
                    // 添加删除按钮的事件监听
                    tableBody.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            if (confirm('确定要删除这条记录吗？')) {
                                deleteRecord(this.getAttribute('data-id'));
                            }
                        });
                    });
                } else {
                    document.getElementById('challengeLeaderboardData').innerHTML = 
                        `<tr><td colspan="6" class="error">获取数据失败: ${result.error || '未知错误'}</td></tr>`;
                }
            } catch (error) {
                document.getElementById('challengeLeaderboardData').innerHTML = 
                    `<tr><td colspan="6" class="error">加载数据时出错: ${error.message || '连接服务器失败'}</td></tr>`;
            }
        }
        
        // 加载高级管理排行榜数据（带分页）
        async function loadAdvancedLeaderboardData(page = 1) {
            try {
                const password = document.getElementById('adminPassword').value;
                
                // 构建查询参数
                const params = new URLSearchParams({
                    page: page,
                    pageSize: 10,
                    sortBy: filterSettings.sortBy
                });
                
                // 添加模式过滤
                if (filterSettings.mode) {
                    params.append('mode', filterSettings.mode);
                    
                    // 添加日期过滤（仅当模式为挑战且指定了日期时）
                    if (filterSettings.mode === 'challenge' && filterSettings.date) {
                        params.append('date', filterSettings.date);
                    }
                }
                
                const response = await fetch(`/api/get-leaderboard?${params.toString()}`, {
                    headers: {
                        'Admin-Password': password
                    }
                });
                const result = await response.json();
                
                if (response.ok) {
                    const tableBody = document.getElementById('advancedLeaderboardData');
                    tableBody.innerHTML = ''; // 清空表格
                    
                    const data = result.data || [];
                    const pagination = result.pagination || { totalPages: 0, currentPage: 1 };
                    
                    // 更新分页状态
                    paginationState = pagination;
                    currentPage = pagination.currentPage;
                    
                    // 更新分页控件
                    updatePaginationControls();
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无排行榜数据</td></tr>';
                        return;
                    }
                    
                    // 计算起始排名
                    const startRank = (pagination.currentPage - 1) * pagination.pageSize + 1;
                    
                    // 将数据添加到表格中
                    data.forEach((item, index) => {
                        const row = document.createElement('tr');
                        const date = new Date(item.date);
                        const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                        
                        // 根据模式显示不同的文本
                        const modeText = item.mode === 'endless' ? '无尽模式' : '每日挑战';
                        
                        row.innerHTML = `
                            <td>${startRank + index}</td>
                            <td>${item.playerName}</td>
                            <td>${item.score}</td>
                            <td>${formattedDate}</td>
                            <td>${modeText}</td>
                            <td class="ip-column">${item.ip || '未知'}</td>
                            <td class="actions-cell">
                                <div class="actions-container">
                                    <button class="delete-btn table-action-btn" data-id="${item.id}">删除</button>
                                    ${item.ip ? `<button class="block-ip-btn table-action-btn" data-ip="${item.ip}">屏蔽IP</button>` : ''}
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // 为高级管理表格添加屏蔽按钮事件 (已在上方添加)
                    // setTimeout(addBlockButtonToTable, 100); // 不再需要单独添加
                    
                    // 添加删除按钮的事件监听
                    tableBody.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            if (confirm('确定要删除这条记录吗？')) {
                                deleteRecord(this.getAttribute('data-id'));
                            }
                        });
                    });
                } else {
                    showResult('error', `获取排行榜数据失败: ${result.error || '未知错误'}`);
                }
            } catch (error) {
                showResult('error', `加载排行榜数据时出错: ${error.message || '连接服务器失败'}`);
            }
        }
        
        // 更新分页控件
        function updatePaginationControls() {
            const { totalPages, currentPage } = paginationState;
            
            // 更新页码信息
            document.getElementById('pageInfo').textContent = `第 ${currentPage}/${totalPages} 页`;
            
            // 启用/禁用上一页和首页按钮
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('firstPage').disabled = currentPage <= 1;
            
            // 启用/禁用下一页和末页按钮
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
            document.getElementById('lastPage').disabled = currentPage >= totalPages;
        }
        
        // 分页事件监听
        document.getElementById('firstPage').addEventListener('click', () => loadAdvancedLeaderboardData(1));
        document.getElementById('prevPage').addEventListener('click', () => loadAdvancedLeaderboardData(currentPage - 1));
        document.getElementById('nextPage').addEventListener('click', () => loadAdvancedLeaderboardData(currentPage + 1));
        document.getElementById('lastPage').addEventListener('click', () => loadAdvancedLeaderboardData(paginationState.totalPages));
        
        // 删除单条记录
        async function deleteRecord(id) {
            try {
                const password = document.getElementById('adminPassword').value;
                const response = await fetch('/api/delete-record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        id: id,
                        password: password 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('success', '记录已成功删除');
                    // 重新加载所有排行榜
                    loadAllLeaderboards();
                } else {
                    showResult('error', `删除失败: ${data.error || '操作失败'}`);
                }
            } catch (error) {
                showResult('error', `删除操作时出错: ${error.message || '连接服务器失败'}`);
            }
        }
        
        // 显示操作结果
        function showResult(type, message) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<p>${message}</p>`;
            
            // 3秒后隐藏消息
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 3000);
        }
        
        // 清空排行榜功能
        document.getElementById('clearButton').addEventListener('click', async function() {
            if (confirm('确定要清空排行榜吗？此操作不可撤销！')) {
                try {
                    const password = document.getElementById('adminPassword').value;
                    const response = await fetch('/api/clear-leaderboard', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password: password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showResult('success', data.message);
                        // 重新加载所有排行榜
                        loadAllLeaderboards();
                    } else {
                        showResult('error', `错误：${data.error || '操作失败'}`);
                    }
                } catch (error) {
                    showResult('error', `错误：${error.message || '连接服务器失败'}`);
                }
            }
        });

        // 加载被屏蔽的IP列表
        async function loadBlockedIps() {
            try {
                const password = document.getElementById('adminPassword').value;
                
                // 显示加载中
                document.getElementById('blockedIpsData').innerHTML = '<tr><td colspan="3" class="loading">加载中...</td></tr>';
                
                const response = await fetch('/api/block-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: password,
                        action: 'list'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const tableBody = document.getElementById('blockedIpsData');
                    // 移除所有子元素和绑定的事件监听器
                    while (tableBody.firstChild) {
                        tableBody.removeChild(tableBody.firstChild);
                    }
                    
                    const blockedIps = result.blockedIps || [];
                    
                    if (blockedIps.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="3" class="empty-data">没有被屏蔽的IP</td></tr>';
                        return;
                    }
                    
                    // 将数据添加到表格中
                    blockedIps.forEach(ipInfo => {
                        const row = document.createElement('tr');
                        const ip = typeof ipInfo === 'string' ? ipInfo : ipInfo.ip;
                        
                        // 格式化时间戳
                        let formattedTime = '';
                        if (ipInfo.timestamp) {
                            const date = new Date(parseInt(ipInfo.timestamp));
                            formattedTime = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                        }
                        
                        // 屏蔽类型标识
                        let blockTypeTag = '';
                        if (typeof ipInfo !== 'string') {
                            const blockType = ipInfo.blockType || 'manual';
                            blockTypeTag = `<span class="block-type block-type-${blockType}">${blockType === 'auto' ? '自动' : '手动'}</span>`;
                        }
                        
                        // 玩家信息（如果有）
                        let playerInfo = '';
                        if (ipInfo.playerName && ipInfo.score) {
                            playerInfo = `<span class="player-info">玩家: ${ipInfo.playerName}, 分数: ${ipInfo.score}</span>`;
                        }
                        
                        // 日期信息（如果有）
                        let dateInfo = '';
                        if (ipInfo.date) {
                            dateInfo = `, 日期: ${ipInfo.date}`;
                        }
                        
                        row.innerHTML = `
                            <td class="ip-column">${ip}</td>
                            <td class="ip-details">
                                ${blockTypeTag}
                                <span class="block-reason">${typeof ipInfo === 'string' ? '管理员手动屏蔽' : (ipInfo.reason || '未知原因')}</span>
                                ${playerInfo}
                                <span class="block-timestamp">${formattedTime ? '屏蔽时间: ' + formattedTime + dateInfo : ''}</span>
                            </td>
                            <td class="actions-cell">
                                <div class="actions-container">
                                    <button class="unblock-btn table-action-btn" data-ip="${ip}">解除屏蔽</button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // 添加解除屏蔽按钮的事件监听
                    tableBody.querySelectorAll('.unblock-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const ip = this.getAttribute('data-ip');
                            unblockIp(ip);
                        });
                    });
                } else {
                    console.error('获取屏蔽IP失败:', result.error || '未知错误');
                    document.getElementById('blockedIpsData').innerHTML = 
                        `<tr><td colspan="3" class="error">获取数据失败: ${result.error || '未知错误'}</td></tr>`;
                }
            } catch (error) {
                console.error('加载屏蔽IP出错:', error);
                document.getElementById('blockedIpsData').innerHTML = 
                    `<tr><td colspan="3" class="error">加载数据时出错: ${error.message || '连接服务器失败'}</td></tr>`;
            }
        }

        // 屏蔽IP
        async function blockIp(ip, reason = '管理员手动屏蔽') {
            try {
                const password = document.getElementById('adminPassword').value;
                
                if (!ip || !ip.trim()) {
                    showResult('error', '请输入有效的IP地址');
                    return;
                }
                
                const response = await fetch('/api/block-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: password,
                        ip: ip.trim(),
                        action: 'block',
                        reason: reason
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('success', result.message || 'IP地址已成功屏蔽');
                    
                    // 清空输入框
                    document.getElementById('ipToBlock').value = '';
                    
                    // 重新加载IP列表
                    loadBlockedIps();
                } else {
                    showResult('error', `屏蔽IP失败: ${result.error || '未知错误'}`);
                }
            } catch (error) {
                showResult('error', `操作时出错: ${error.message || '连接服务器失败'}`);
            }
        }

        // 解除IP屏蔽
        async function unblockIp(ip) {
            if (confirm(`确定要解除对IP ${ip} 的屏蔽吗？`)) {
                try {
                    const password = document.getElementById('adminPassword').value;
                    
                    const response = await fetch('/api/block-ip', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            password: password,
                            ip: ip,
                            action: 'unblock'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        showResult('success', result.message || 'IP地址已解除屏蔽');
                        
                        // 重新加载IP列表
                        loadBlockedIps();
                    } else {
                        showResult('error', `解除屏蔽失败: ${result.error || '未知错误'}`);
                    }
                } catch (error) {
                    showResult('error', `操作时出错: ${error.message || '连接服务器失败'}`);
                }
            }
        }

        // 添加IP屏蔽按钮事件
        document.getElementById('blockIpBtn').addEventListener('click', function() {
            const ip = document.getElementById('ipToBlock').value;
            blockIp(ip);
        });

        // 屏蔽指定IP（从表格中的操作）
        function blockIpFromTable(ip) {
            const reason = prompt(`请输入屏蔽IP ${ip} 的原因:`, '管理员手动屏蔽');
            if (reason !== null) {
                blockIp(ip, reason);
            }
        }

        // 刷新IP列表按钮
        document.getElementById('refreshBlockedIpsBtn').addEventListener('click', function() {
            loadBlockedIps();
        });

        // 为表格中的IP地址添加屏蔽操作
        function addBlockButtonToTable() {
            // 首先移除所有现有的屏蔽按钮，防止重复添加
            document.querySelectorAll('.block-ip-btn').forEach(btn => {
                btn.remove();
            });
            
            // 为无尽模式表格添加屏蔽按钮
            document.querySelectorAll('#endlessLeaderboardData tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const ipCell = cells[4];
                    const ip = ipCell.textContent;
                    if (ip && ip !== '未知') {
                        const actionCell = cells[5];
                        const blockButton = document.createElement('button');
                        blockButton.className = 'block-ip-btn table-action-btn';
                        blockButton.textContent = '屏蔽IP';
                        blockButton.style.marginLeft = '5px';
                        blockButton.setAttribute('data-ip', ip);
                        blockButton.addEventListener('click', function() {
                            blockIpFromTable(ip);
                        });
                        actionCell.appendChild(blockButton);
                    }
                }
            });
            
            // 为每日挑战表格添加屏蔽按钮
            document.querySelectorAll('#challengeLeaderboardData tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const ipCell = cells[4];
                    const ip = ipCell.textContent;
                    if (ip && ip !== '未知') {
                        const actionCell = cells[5];
                        const blockButton = document.createElement('button');
                        blockButton.className = 'block-ip-btn table-action-btn';
                        blockButton.textContent = '屏蔽IP';
                        blockButton.style.marginLeft = '5px';
                        blockButton.setAttribute('data-ip', ip);
                        blockButton.addEventListener('click', function() {
                            blockIpFromTable(ip);
                        });
                        actionCell.appendChild(blockButton);
                    }
                }
            });
            
            // 为高级管理表格添加屏蔽按钮
            document.querySelectorAll('#advancedLeaderboardData tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const ipCell = cells[5];
                    const ip = ipCell.textContent;
                    if (ip && ip !== '未知') {
                        const actionCell = cells[6];
                        const blockButton = document.createElement('button');
                        blockButton.className = 'block-ip-btn table-action-btn';
                        blockButton.textContent = '屏蔽IP';
                        blockButton.style.marginLeft = '5px';
                        blockButton.setAttribute('data-ip', ip);
                        blockButton.addEventListener('click', function() {
                            blockIpFromTable(ip);
                        });
                        actionCell.appendChild(blockButton);
                    }
                }
            });
        }

        // 为动态添加的屏蔽IP按钮添加事件监听器
        function addBlockIpListeners() {
            document.querySelectorAll('.block-ip-btn').forEach(button => {
                 // 先移除旧的监听器，防止重复绑定
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                newButton.addEventListener('click', function() {
                    const ip = this.getAttribute('data-ip');
                    if (ip && confirm(`确定要屏蔽IP地址 ${ip} 吗？`)) {
                        blockIp(ip, 'Manually blocked from leaderboard');
                    }
                });
            });
        }
    </script>
</body>
</html> 